@page "/calculators/bmi"

@using BlazorMedCalculator.Domain.Calculators
@using BlazorMedCalculator.Application.Models
@using BlazorMedCalculator.Web.Components.Content
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization

@inject BlazorMedCalculator.Application.Interfaces.IContentService ContentService
@inject PdfEmailService PdfEmailService

<h1>BMI Calculator</h1>

<MarkdownView Markdown="@_article" />

<hr />

<!-- ===== Calculation form ===== -->
<EditForm Model="_input" OnValidSubmit="Calculate">
    <DataAnnotationsValidator />

    <div>
        <label>Weight (kg)</label><br />
        <InputNumber @bind-Value="_input.WeightKg" />
    </div>

    <div>
        <label>Height (cm)</label><br />
        <InputNumber @bind-Value="_input.HeightCm" />
    </div>

    <button type="submit">Calculate</button>
</EditForm>

@if (_result is not null)
{
    <hr />
    <h3>Result</h3>

    <p><strong>BMI:</strong> @_result.Outputs["bmi"]</p>
    <p><strong>Classification:</strong> @_result.Outputs["category"]</p>

    <AuthorizeView Roles="User,Admin">
        <Authorized>
            <!-- ===== Download PDF ===== -->
            <form method="post" action="/api/pdf/@_result.CalculatorCode">
                <input type="hidden" name="CalculatorCode" value="@_result.CalculatorCode" />

                @foreach (var i in _result.Inputs)
                {
                    <input type="hidden" name="Inputs[@i.Key]" value="@i.Value" />
                }

                @foreach (var o in _result.Outputs)
                {
                    <input type="hidden" name="Outputs[@o.Key]" value="@o.Value" />
                }

                <button type="submit">Download PDF</button>
            </form>
            <!-- ===== Send PDF Report ===== -->
            <div style="margin-top:10px">
                <button type="button" @onclick="SendPdfByEmail">
                    Send PDF by Email
                </button>
            </div>
        </Authorized>

        <NotAuthorized>
            <p>
                <em>
                    Please sign in to download or email your PDF result.
                </em>
            </p>
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    private string _article = string.Empty;
    private BmiInput _input = new();
    private CalculationResult? _result;

    protected override async Task OnInitializedAsync()
    {
        _article = await ContentService.GetCalculatorArticleAsync("bmi");
    }

    private void Calculate()
    {
        var bmi = BlazorMedCalculator.Domain.Calculators.BmiCalculator.Calculate(
            _input.WeightKg,
            _input.HeightCm);

        var category = BlazorMedCalculator.Domain.Calculators.BmiClassifier.Classify(bmi);

        _result = new CalculationResult
        {
            CalculatorCode = "bmi",
            Inputs = new Dictionary<string, string>
            {
                ["weightKg"] = _input.WeightKg.ToString(),
                ["heightCm"] = _input.HeightCm.ToString()
            },
            Outputs = new Dictionary<string, string>
            {
                ["bmi"] = bmi.ToString("0.00"),
                ["category"] = category
            }
        };
    }

    private async Task SendPdfByEmail()
    {
        if (_result is null)
            return;

        await PdfEmailService.SendResultAsync(_result);
    }

    private sealed class BmiInput
    {
        [Range(1, 500, ErrorMessage = "Weight must be positive")]
        public double WeightKg { get; set; }

        [Range(30, 300, ErrorMessage = "Height must be positive")]
        public double HeightCm { get; set; }
    }
}



