@page "/calculators/bmi"

@using System.ComponentModel.DataAnnotations
@using BlazorMedCalculator.Web.Calculators
@using BlazorMedCalculator.Web.Components.Content
@using BlazorMedCalculator.Web.Components.Templates
@using BlazorMedCalculator.Web.Interfaces
@using BlazorMedCalculator.Web.Models

@inject IContentService ContentService
@inject PdfEmailService PdfEmailService

<h1>BMI Calculator</h1>

<MarkdownView Markdown="@_article" />

<hr />

<!-- ===== Calculation form ===== -->
<EditForm Model="_input" OnValidSubmit="Calculate">
    <DataAnnotationsValidator />

    <div>
        <label>Weight (kg)</label><br />
        <InputNumber @bind-Value="_input.WeightKg" />
    </div>

    <div>
        <label>Height (cm)</label><br />
        <InputNumber @bind-Value="_input.HeightCm" />
    </div>

    <button type="submit">Calculate</button>
</EditForm>

<CalculatorResultTemplate
    Result="_result"
    OnSendEmail="SendPdfByEmail">

    <ResultContent>
        <p><strong>BMI:</strong> @_result!.Outputs["bmi"]</p>
        <p><strong>Classification:</strong> @_result!.Outputs["category"]</p>
    </ResultContent>

</CalculatorResultTemplate>

@code {
    private string _article = string.Empty;
    private BmiInput _input = new();
    private CalculationResult? _result;

    protected override async Task OnInitializedAsync()
    {
        _article = await ContentService.GetCalculatorArticleAsync("bmi");
    }

    private void Calculate()
    {
        var bmi = Web.Calculators.BmiCalculator.Calculate(
            _input.WeightKg,
            _input.HeightCm);

        var category = BmiClassifier.Classify(bmi);

        _result = new CalculationResult
        {
            CalculatorCode = "bmi",
            Inputs = new Dictionary<string, string>
            {
                ["weightKg"] = _input.WeightKg.ToString(),
                ["heightCm"] = _input.HeightCm.ToString()
            },
            Outputs = new Dictionary<string, string>
            {
                ["bmi"] = bmi.ToString("0.00"),
                ["category"] = category
            }
        };
    }

    private async Task SendPdfByEmail()
    {
        if (_result is null)
            return;

        await PdfEmailService.SendResultAsync(_result);
    }

    private sealed class BmiInput
    {
        [Range(1, 500)]
        public double WeightKg { get; set; }

        [Range(30, 300)]
        public double HeightCm { get; set; }
    }
}


